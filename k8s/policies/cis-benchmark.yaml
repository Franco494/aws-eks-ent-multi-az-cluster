apiVersion: templates.gatekeeper.sh/v1beta1
kind: ConstraintTemplate
metadata:
  name: k8scisbenchmark
spec:
  crd:
    spec:
      names:
        kind: K8sCISBenchmark
      validation:
        openAPIV3Schema:
          type: object
  targets:
    - target: admission.k8s.gatekeeper.sh
      rego: |
        package k8scisbenchmark
        
        # CIS 5.1.3 - Minimize wildcard use in Roles and ClusterRoles
        violation[{"msg": msg}] {
          input.review.object.kind in ["Role", "ClusterRole"]
          rule := input.review.object.rules[_]
          "*" in rule.resources
          msg := sprintf("%s should not use wildcard in resources", [input.review.object.kind])
        }
        
        # CIS 5.1.4 - Minimize access to create pods
        violation[{"msg": msg}] {
          input.review.object.kind in ["Role", "ClusterRole"]
          rule := input.review.object.rules[_]
          "pods" in rule.resources
          "create" in rule.verbs
          msg := sprintf("%s should minimize pod creation access", [input.review.object.kind])
        }
---
apiVersion: constraints.gatekeeper.sh/v1beta1
kind: K8sCISBenchmark
metadata:
  name: cis-benchmark-compliance
spec:
  match:
    kinds:
      - apiGroups: ["rbac.authorization.k8s.io"]
        kinds: ["Role", "ClusterRole"]