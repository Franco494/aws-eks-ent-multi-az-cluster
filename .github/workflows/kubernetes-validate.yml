name: Kubernetes Validation

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
    paths:
      - 'k8s/**'
      - '.github/workflows/kubernetes-validate.yml'

jobs:
  kubernetes-validate:
    name: Kubernetes Manifests Validation
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup kubeval
      run: |
        set -e
        wget https://github.com/instrumenta/kubeval/releases/latest/download/kubeval-linux-amd64.tar.gz || { echo "Failed to download kubeval"; exit 1; }
        tar xf kubeval-linux-amd64.tar.gz || { echo "Failed to extract kubeval"; exit 1; }
        sudo mv kubeval /usr/local/bin || { echo "Failed to install kubeval"; exit 1; }
        
    - name: Validate Kubernetes manifests
      run: |
        find k8s/ -name '*.yaml' -o -name '*.yml' | xargs kubeval || echo "Kubeval completed"
        
    - name: Setup kube-score
      run: |
        set -e
        wget https://github.com/zegl/kube-score/releases/download/v1.16.1/kube-score_1.16.1_linux_amd64.tar.gz || { echo "Failed to download kube-score"; exit 1; }
        tar xzf kube-score_1.16.1_linux_amd64.tar.gz || { echo "Failed to extract kube-score"; exit 1; }
        sudo mv kube-score /usr/local/bin || { echo "Failed to install kube-score"; exit 1; }
        
    - name: Run kube-score
      run: |
        find k8s/ -name '*.yaml' -o -name '*.yml' | xargs kube-score score || echo "Kube-score completed"