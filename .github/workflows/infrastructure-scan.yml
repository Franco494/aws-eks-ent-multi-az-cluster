name: Infrastructure Security Scan

on:
  schedule:
    - cron: '0 5 * * 4'  # Weekly on Thursday at 5 AM
  push:
    branches: [ main ]
    paths:
      - 'terraform/**'
      - 'k8s/security/**'
      - 'k8s/policies/**'

jobs:
  infrastructure-scan:
    name: Infrastructure Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Terraform security scan
      uses: bridgecrewio/checkov-action@v12
      with:
        directory: terraform/
        framework: terraform
        soft_fail: true
        output_format: cli
        
    - name: Kubernetes security scan
      uses: bridgecrewio/checkov-action@v12
      with:
        directory: k8s/
        framework: kubernetes
        soft_fail: true
        output_format: cli
        compact: true
        quiet: true
        
    - name: Terraform static analysis
      run: |
        echo "üîç Running Terraform static analysis"
        find terraform/ -name "*.tf" | head -10 || echo "No Terraform files found"
        
    - name: Kubernetes policy validation
      run: |
        echo "üìã Validating Kubernetes security policies"
        find k8s/ -name "*policy*" -o -name "*security*" | head -5 || echo "No policy files found"